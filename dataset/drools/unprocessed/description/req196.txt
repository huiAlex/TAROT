Improve the quality of the tests, add more test cases and clean the tests code.
